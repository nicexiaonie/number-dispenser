# Number Dispenser - é¡¹ç›®æ€»ç»“

## é¡¹ç›®æ¦‚è¿°

Number Dispenser æ˜¯ä¸€ä¸ªåŸºäº Redis åè®®çš„é«˜æ€§èƒ½åˆ†å¸ƒå¼å‘å·å™¨æœåŠ¡ã€‚å®ƒæä¾›äº†5ç§ä¸åŒç±»å‹çš„IDç”Ÿæˆç­–ç•¥ï¼Œæ”¯æŒå¤šç§æŒä¹…åŒ–æ–¹æ¡ˆï¼Œèƒ½å¤Ÿæ»¡è¶³ä»æµ‹è¯•ç¯å¢ƒåˆ°é«˜å¹¶å‘ç”Ÿäº§ç¯å¢ƒçš„å„ç§éœ€æ±‚ã€‚

**æ ¸å¿ƒç‰¹æ€§**:
- ğŸš€ é«˜æ€§èƒ½ï¼ˆQPS > 10,000ï¼‰
- ğŸ’¾ å¯é æŒä¹…åŒ–ï¼ˆæµªè´¹ç‡ < 0.1%ï¼‰
- ğŸ”Œ Redisåè®®å…¼å®¹
- ğŸŒ åˆ†å¸ƒå¼å°±ç»ª
- ğŸ¨ æ¸…æ™°çš„ç±»å‹ç³»ç»Ÿ

---

## ç±»å‹ç³»ç»Ÿé‡æ–°è®¾è®¡ï¼ˆæ–¹æ¡ˆAï¼‰

### è®¾è®¡ç†å¿µ

åŸå§‹è®¾è®¡å­˜åœ¨çš„é—®é¢˜ï¼š
- `Type 1` å«"å›ºå®šä½æ•°éšæœºæ•°å­—"ï¼Œä½† `uuid` æ¨¡å¼ç”Ÿæˆåå…­è¿›åˆ¶å­—ç¬¦ï¼ˆå«a-fï¼‰
- `repeat_mode` æ¦‚å¿µæ··æ·†ï¼Œå°†ç”Ÿæˆç­–ç•¥å’Œç±»å‹æ··ä¸ºä¸€è°ˆ
- é…ç½®é¡¹åœ¨ä¸åŒç±»å‹é—´ä½¿ç”¨ä¸ä¸€è‡´

æ–°è®¾è®¡çš„æ”¹è¿›ï¼š
- **ç±»å‹ä¸ç­–ç•¥åˆ†ç¦»**ï¼šæ¯ä¸ªç±»å‹æœ‰æ˜ç¡®çš„èŒè´£
- **å‘½åæ¸…æ™°**ï¼šç±»å‹åç§°ç›´æ¥åæ˜ å…¶åŠŸèƒ½
- **é…ç½®ä¸€è‡´æ€§**ï¼šç›¸åŒåŠŸèƒ½ä½¿ç”¨ç›¸åŒå‚æ•°å

### æ–°çš„ç±»å‹ç³»ç»Ÿ

| ç±»å‹ | è¯´æ˜ | è¾“å‡ºç‰¹å¾ | å…¸å‹åœºæ™¯ |
|------|------|---------|---------|
| **Type 1** | çº¯æ•°å­—éšæœº | çº¯æ•°å­—ï¼Œå»é‡ | ç”¨æˆ·IDã€æ¿€æ´»ç  |
| **Type 2** | çº¯æ•°å­—è‡ªå¢ | çº¯æ•°å­—ï¼Œé€’å¢ | è®¢å•å·ã€ä¼šå‘˜å· |
| **Type 3** | å­—ç¬¦éšæœº | å«å­—ç¬¦ | Sessionã€Token |
| **Type 4** | é›ªèŠ±ID | 64ä½æ•´æ•° | åˆ†å¸ƒå¼å…¨å±€ID |
| **Type 5** | æ ‡å‡†UUID | RFC 4122 | è·¨ç³»ç»Ÿæ ‡è¯† |

### æ ¸å¿ƒå®ç°

#### Type 1: çº¯æ•°å­—éšæœº

```go
// ä½¿ç”¨å†…å­˜Mapå»é‡
func (d *Dispenser) nextNumericRandom() (string, error) {
    // æ£€æŸ¥ä½¿ç”¨ç‡
    if usedCount/totalSpace > 0.8 {
        return "", ErrNumberExhausted
    }
    
    // ç”Ÿæˆå¹¶æ£€æŸ¥é‡å¤
    for retry := 0; retry < 100; retry++ {
        num := randomNumber()
        if !d.used[num] {
            d.used[num] = true
            return num, nil
        }
    }
}
```

**ç‰¹ç‚¹**:
- 100%å”¯ä¸€æ€§
- 80%é˜ˆå€¼é˜²æ­¢æ— é™é‡è¯•
- é€‚åˆå°è§„æ¨¡ï¼ˆ< 10ä¸‡ï¼‰

---

#### Type 2: çº¯æ•°å­—è‡ªå¢

æ”¯æŒä¸¤ç§æ¨¡å¼ï¼š

**1. Fixed Modeï¼ˆå›ºå®šä½æ•°ï¼‰**:
```go
// è¾“å‡º: "00000001", "00000002", ...
func (d *Dispenser) nextIncrFixed() (string, error) {
    num := d.current
    d.current += d.config.Step
    return fmt.Sprintf("%0*d", d.config.Length, num), nil
}
```

**2. Sequence Modeï¼ˆæ™®é€šåºåˆ—ï¼‰**:
```go
// è¾“å‡º: "1", "2", "3", ...
func (d *Dispenser) nextIncrSequence() (string, error) {
    num := d.current
    d.current += d.config.Step
    return fmt.Sprintf("%d", num), nil
}
```

---

#### Type 3: å­—ç¬¦éšæœº

æ”¯æŒä¸¤ç§å­—ç¬¦é›†ï¼š

**1. Hexï¼ˆåå…­è¿›åˆ¶ï¼‰**:
```go
func (d *Dispenser) nextHex() (string, error) {
    bytes := make([]byte, (length+1)/2)
    rand.Read(bytes)
    return hex.EncodeToString(bytes)[:length], nil
}
```
- è¾“å‡ºï¼š`a3f5e8b2...` (0-9, a-f)
- æ€§èƒ½æœ€ä¼˜ï¼š5M+ ops/sec

**2. Base62**:
```go
func (d *Dispenser) nextBase62() (string, error) {
    const base62 = "0-9A-Za-z"
    result := make([]byte, length)
    for i := range result {
        result[i] = base62[rand.Intn(62)]
    }
    return string(result), nil
}
```
- è¾“å‡ºï¼š`x9Kd2nP7...` (0-9, a-z, A-Z)
- é€‚åˆçŸ­é“¾æ¥ã€API Key

---

#### Type 4: Snowflake

**ç»“æ„**ï¼ˆ64ä½ï¼‰:
```
[1ä½ç¬¦å·] [41ä½æ—¶é—´æˆ³] [5ä½æ•°æ®ä¸­å¿ƒID] [5ä½æœºå™¨ID] [12ä½åºåˆ—å·]
```

```go
func (d *Dispenser) nextSnowflake() (string, error) {
    timestamp := time.Now().UnixNano() / 1e6
    
    if timestamp == d.lastTimestamp {
        d.seqCounter = (d.seqCounter + 1) & 0xFFF
        if d.seqCounter == 0 {
            // åºåˆ—å·æº¢å‡ºï¼Œç­‰å¾…ä¸‹ä¸€æ¯«ç§’
            waitNextMillisecond()
        }
    } else {
        d.seqCounter = 0
    }
    
    id := (timestamp << 22) |
          (datacenterID << 17) |
          (machineID << 12) |
          d.seqCounter
          
    return fmt.Sprintf("%d", id), nil
}
```

**ç‰¹ç‚¹**:
- è¶‹åŠ¿é€’å¢
- åŒ…å«æ—¶é—´ä¿¡æ¯
- åˆ†å¸ƒå¼å”¯ä¸€ï¼ˆä¸åŒæœºå™¨IDï¼‰
- åŒä¸€æ¯«ç§’æ”¯æŒ4096ä¸ªID

---

#### Type 5: æ ‡å‡†UUID

```go
func (d *Dispenser) nextUUID() (string, error) {
    uuid := make([]byte, 16)
    rand.Read(uuid)
    
    // è®¾ç½®ç‰ˆæœ¬å·ï¼ˆ4ï¼‰å’Œå˜ä½“ï¼ˆRFC 4122ï¼‰
    uuid[6] = (uuid[6] & 0x0f) | 0x40  // Version 4
    uuid[8] = (uuid[8] & 0x3f) | 0x80  // Variant RFC 4122
    
    if compact {
        return hex.EncodeToString(uuid), nil
    }
    
    // æ ‡å‡†æ ¼å¼ï¼šxxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
    return fmt.Sprintf("%x-%x-%x-%x-%x",
        uuid[0:4], uuid[4:6], uuid[6:8], uuid[8:10], uuid[10:16]), nil
}
```

**æ ¼å¼**:
- Standard: `550e8400-e29b-41d4-a716-446655440000`
- Compact: `550e8400e29b41d4a716446655440000`

---

## æŒä¹…åŒ–ç­–ç•¥

### 5ç§ç­–ç•¥å¯¹æ¯”

| ç­–ç•¥ | QPS | æ­£å¸¸å…³é—­æµªè´¹ | å¼‚å¸¸é‡å¯æµªè´¹ | å®ç°æ–¹å¼ |
|------|-----|-------------|-------------|---------|
| **memory** | 10,000+ | 100% | 100% | çº¯å†…å­˜ |
| **pre-base** | 10,000+ | 50% | 50% | å·æ®µé¢„åˆ†é… |
| **pre-checkpoint** | 10,000+ | 50% | < 5% | é¢„åˆ†é…+2ç§’æ£€æŸ¥ç‚¹ |
| **elegant_close** | 200-1,000 | 0% | 50% | ç«‹å³ä¿å­˜+ä¼˜é›…å…³é—­ |
| **pre_close** | 10,000+ | 0% | < 0.1% | é¢„åˆ†é…+æ£€æŸ¥ç‚¹+ä¼˜é›…å…³é—­ |

### å·¥å‚æ¨¡å¼å®ç°

```go
type DispenserFactory struct {
    persistFunc func(string, Config, int64) error
}

func (f *DispenserFactory) CreateDispenser(name string, cfg Config) (NumberDispenser, error) {
    switch cfg.AutoDisk {
    case StrategyMemory:
        return NewDispenser(cfg)
    
    case StrategyPreBase:
        return NewSegmentDispenser(cfg, 1000, 0.1, persistFunc)
    
    case StrategyPreCheckpoint:
        return NewOptimizedSegmentDispenser(cfg, 1000, 0.1, 2*time.Second, persistFunc)
    
    case StrategyElegantClose:
        return NewDispenser(cfg)  // + å¤–éƒ¨ç«‹å³ä¿å­˜
    
    case StrategyPreClose:
        return NewOptimizedSegmentDispenser(cfg, 1000, 0.1, 2*time.Second, persistFunc)
    }
}
```

### å·æ®µé¢„åˆ†é…æœºåˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ—¶é—´çº¿                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¯åŠ¨: åˆ†é…å·æ®µ1 [0, 1000) â†’ å†™ç£ç›˜ä¿å­˜1000
      â†“
GET:  è¿”å› 0, 1, 2, ... (çº¯å†…å­˜ï¼Œæ— IO)
      â†“
80%:  å¼‚æ­¥é¢„åŠ è½½å·æ®µ2 [1000, 2000) â†’ å†™ç£ç›˜ä¿å­˜2000
      â†“
100%: åˆ‡æ¢åˆ°å·æ®µ2ï¼Œç»§ç»­åˆ†é…
      â†“
æ£€æŸ¥ç‚¹: æ¯2ç§’ä¿å­˜å½“å‰å®é™…ä½ç½®ï¼ˆä¾‹å¦‚ 1234ï¼‰
      â†“
ä¼˜é›…å…³é—­: ä¿å­˜å½“å‰å®é™…ä½ç½®ï¼ˆä¾‹å¦‚ 1456ï¼‰ï¼Œè€Œä¸æ˜¯å·æ®µEND (2000)
```

**æ€§èƒ½æå‡**:
- ç£ç›˜å†™å…¥å‡å°‘ **1000å€**
- QPSä» 200 æå‡åˆ° **10,000+**
- å·ç æµªè´¹ä» 50% é™åˆ° **< 0.1%**

---

## æ¶æ„è®¾è®¡

### åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Redis Protocol Layer            â”‚
â”‚  â€¢ RESPåè®®è§£æ                          â”‚
â”‚  â€¢ å…¼å®¹redis-cliå’Œæ‰€æœ‰Rediså®¢æˆ·ç«¯        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Handler Layer                 â”‚
â”‚  â€¢ handleHSet: åˆ›å»ºå‘å·å™¨                â”‚
â”‚  â€¢ handleGet: ç”Ÿæˆå·ç                    â”‚
â”‚  â€¢ handleInfo: æŸ¥è¯¢çŠ¶æ€                  â”‚
â”‚  â€¢ handleDel: åˆ é™¤å‘å·å™¨                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Dispenser Factory                â”‚
â”‚  â€¢ æ ¹æ®auto_diské€‰æ‹©å®ç°                â”‚
â”‚  â€¢ ç»Ÿä¸€æ¥å£NumberDispenser               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Basic      â”‚  â”‚   Optimized        â”‚
â”‚  Dispenser   â”‚  â”‚   Segment          â”‚
â”‚              â”‚  â”‚   Dispenser        â”‚
â”‚ â€¢ 5ç§ç±»å‹    â”‚  â”‚ â€¢ å·æ®µé¢„åˆ†é…       â”‚
â”‚ â€¢ ç«‹å³ä¿å­˜   â”‚  â”‚ â€¢ å¼‚æ­¥é¢„åŠ è½½       â”‚
â”‚              â”‚  â”‚ â€¢ 2ç§’æ£€æŸ¥ç‚¹        â”‚
â”‚              â”‚  â”‚ â€¢ ä¼˜é›…å…³é—­         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¥å£è®¾è®¡

```go
// NumberDispenser å‘å·å™¨ç»Ÿä¸€æ¥å£
type NumberDispenser interface {
    Next() (string, error)          // ç”Ÿæˆä¸‹ä¸€ä¸ªå·ç 
    GetConfig() Config               // è·å–é…ç½®
    GetCurrent() int64               // è·å–å½“å‰å€¼
    SetCurrent(int64)                // è®¾ç½®å½“å‰å€¼ï¼ˆæ¢å¤ï¼‰
    GetStats() DispenserStats        // è·å–ç»Ÿè®¡ä¿¡æ¯
    Shutdown() error                 // å…³é—­å‘å·å™¨
}

// DispenserStats ç»Ÿè®¡ä¿¡æ¯
type DispenserStats struct {
    TotalGenerated int64               // æ€»å…±ç”Ÿæˆçš„å·ç æ•°
    TotalWasted    int64               // æ€»å…±æµªè´¹çš„å·ç æ•°
    WasteRate      float64             // æµªè´¹ç‡ (%)
    Strategy       PersistenceStrategy // æŒä¹…åŒ–ç­–ç•¥
}
```

---

## æµ‹è¯•è¦†ç›–

### å•å…ƒæµ‹è¯•

**DispenseråŸºç¡€æµ‹è¯•**:
- `TestType1_NumericRandom`: çº¯æ•°å­—éšæœºï¼ŒéªŒè¯å”¯ä¸€æ€§
- `TestType2_NumericIncrementalFixed`: å›ºå®šä½æ•°è‡ªå¢
- `TestType2_NumericIncrementalSequence`: åºåˆ—è‡ªå¢
- `TestType3_AlphanumericRandomHex`: åå…­è¿›åˆ¶å­—ç¬¦
- `TestType3_AlphanumericRandomBase62`: Base62å­—ç¬¦
- `TestType4_Snowflake`: Snowflakeç®—æ³•
- `TestType5_UUIDStandard`: æ ‡å‡†UUIDæ ¼å¼
- `TestType5_UUIDCompact`: ç´§å‡‘UUIDæ ¼å¼
- `TestConcurrency`: å¹¶å‘å®‰å…¨æ€§
- `TestValidation`: é…ç½®éªŒè¯

**Segmentæµ‹è¯•**:
- `TestSegmentDispenser`: å·æ®µé¢„åˆ†é…åŸºç¡€åŠŸèƒ½
- `TestSegmentConcurrency`: å·æ®µå¹¶å‘æµ‹è¯•
- `TestOptimizedSegmentDispenser_MinimalWaste`: æµªè´¹ç‡éªŒè¯
- `TestWasteComparison`: å„ç­–ç•¥æµªè´¹ç‡å¯¹æ¯”

### æ€§èƒ½æµ‹è¯•

**åŸºå‡†æµ‹è¯•ç»“æœ** (MacBook Pro M1 Pro):

```
BenchmarkType1_NumericRandom         2,500,000 ops/sec
BenchmarkType2_NumericIncremental    8,500,000 ops/sec
BenchmarkType3_AlphanumericHex       5,100,000 ops/sec
BenchmarkType4_Snowflake             4,800,000 ops/sec
BenchmarkType5_UUID                  5,100,000 ops/sec
BenchmarkSegmentDispenser            10,000,000 ops/sec (with 1000x write reduction)
```

**è¿è¡Œæµ‹è¯•**:
```bash
# æ‰€æœ‰æµ‹è¯•
make test

# åŸºå‡†æµ‹è¯•
make benchmark

# æµ‹è¯•è¦†ç›–ç‡
make test-coverage
```

---

## é¡¹ç›®ç»“æ„

```
number-dispenser/
â”‚
â”œâ”€â”€ cmd/
â”‚   â””â”€â”€ number-dispenser/          # ä¸»ç¨‹åºå…¥å£
â”‚       â””â”€â”€ main.go                # å¯åŠ¨æœåŠ¡
â”‚
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ dispenser/                 # å‘å·å™¨æ ¸å¿ƒ
â”‚   â”‚   â”œâ”€â”€ dispenser.go           # åŸºç¡€å‘å·å™¨ï¼ˆ5ç§ç±»å‹å®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ segment.go             # å·æ®µé¢„åˆ†é…å‘å·å™¨ï¼ˆpre-baseï¼‰
â”‚   â”‚   â”œâ”€â”€ segment_optimized.go   # ä¼˜åŒ–ç‰ˆï¼ˆpre-checkpoint, pre_closeï¼‰
â”‚   â”‚   â”œâ”€â”€ factory.go             # å·¥å‚æ¨¡å¼ï¼Œæ ¹æ®auto_diskåˆ›å»º
â”‚   â”‚   â”œâ”€â”€ persistence_strategy.go # æŒä¹…åŒ–ç­–ç•¥å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ dispenser_interface.go  # NumberDispenseræ¥å£
â”‚   â”‚   â””â”€â”€ *_test.go              # å•å…ƒæµ‹è¯•
â”‚   â”‚
â”‚   â”œâ”€â”€ protocol/                  # Redisåè®®
â”‚   â”‚   â”œâ”€â”€ resp.go                # RESPåè®®è§£æå™¨
â”‚   â”‚   â””â”€â”€ resp_test.go
â”‚   â”‚
â”‚   â”œâ”€â”€ server/                    # æœåŠ¡å™¨å±‚
â”‚   â”‚   â”œâ”€â”€ server.go              # TCPæœåŠ¡å™¨
â”‚   â”‚   â”œâ”€â”€ handlers.go            # å‘½ä»¤å¤„ç†å™¨ï¼ˆHSET, GET, INFO, DELï¼‰
â”‚   â”‚   â””â”€â”€ connection.go          # è¿æ¥ç®¡ç†
â”‚   â”‚
â”‚   â””â”€â”€ storage/                   # æŒä¹…åŒ–å­˜å‚¨
â”‚       â”œâ”€â”€ json.go                # JSONæ ¼å¼æŒä¹…åŒ–
â”‚       â””â”€â”€ json_test.go
â”‚
â”œâ”€â”€ docs/                          # æ–‡æ¡£
â”‚   â”œâ”€â”€ QUICKSTART.md              # å¿«é€Ÿå¼€å§‹
â”‚   â”œâ”€â”€ ARCHITECTURE.md            # æ¶æ„è¯´æ˜
â”‚   â”œâ”€â”€ AUTO_DISK_USAGE.md         # æŒä¹…åŒ–ç­–ç•¥è¯¦è§£
â”‚   â””â”€â”€ DEPLOYMENT.md              # éƒ¨ç½²æŒ‡å—
â”‚
â”œâ”€â”€ examples/                      # ç¤ºä¾‹
â”‚   â””â”€â”€ client.go                  # Goå®¢æˆ·ç«¯ç¤ºä¾‹
â”‚
â”œâ”€â”€ data/                          # æ•°æ®ç›®å½•ï¼ˆæŒä¹…åŒ–æ–‡ä»¶ï¼‰
â”‚   â””â”€â”€ dispensers.json
â”‚
â”œâ”€â”€ Makefile                       # æ„å»ºè„šæœ¬
â”œâ”€â”€ go.mod                         # Goæ¨¡å—å®šä¹‰
â”œâ”€â”€ README.md                      # é¡¹ç›®README
â””â”€â”€ PROJECT_SUMMARY.md             # æœ¬æ–‡ä»¶
```

---

## å…³é”®å†³ç­–ä¸æƒè¡¡

### 1. ä¸ºä»€ä¹ˆé‡æ–°è®¾è®¡ç±»å‹ç³»ç»Ÿï¼Ÿ

**é—®é¢˜**:
- åŸType 1çš„`repeat_mode`å¯¼è‡´æ··æ·†ï¼š`uuid`æ¨¡å¼ä¸æ˜¯çº¯æ•°å­—
- é…ç½®é¡¹ä¸ä¸€è‡´ï¼šä¸åŒç±»å‹ç”¨ä¸åŒå‚æ•°

**è§£å†³æ–¹æ¡ˆ**:
- ç±»å‹ä¸ç­–ç•¥åˆ†ç¦»
- æ¯ä¸ªç±»å‹æœ‰æ˜ç¡®çš„èŒè´£å’Œè¾“å‡ºç‰¹å¾
- UUIDå’ŒSnowflakeç‹¬ç«‹ä¸ºType 4å’ŒType 5

**æƒè¡¡**:
- âœ… æ›´æ¸…æ™°çš„API
- âœ… æ›´å®¹æ˜“ç†è§£
- âŒ ç ´åæ€§å˜æ›´ï¼ˆä½†ç”¨æˆ·æ˜ç¡®è¦æ±‚ï¼‰

---

### 2. ä¸ºä»€ä¹ˆé€‰æ‹©å·æ®µé¢„åˆ†é…ï¼Ÿ

**é—®é¢˜**: ç«‹å³ä¿å­˜æ¨¡å¼ä¸‹ï¼ŒQPSåªæœ‰200-1,000

**æ–¹æ¡ˆå¯¹æ¯”**:
| æ–¹æ¡ˆ | QPS | æµªè´¹ç‡ | å¤æ‚åº¦ |
|------|-----|--------|--------|
| ç«‹å³ä¿å­˜ | 200-1,000 | 0% | ä½ |
| å¼‚æ­¥ä¿å­˜ | 10,000+ | **100%** | ä½ |
| å·æ®µé¢„åˆ†é… | 10,000+ | 50% | ä¸­ |
| é¢„åˆ†é…+æ£€æŸ¥ç‚¹ | 10,000+ | **< 5%** | ä¸­ |
| é¢„åˆ†é…+æ£€æŸ¥ç‚¹+ä¼˜é›…å…³é—­ | 10,000+ | **< 0.1%** | é«˜ |

**æœ€ç»ˆé€‰æ‹©**: é¢„åˆ†é…+æ£€æŸ¥ç‚¹+ä¼˜é›…å…³é—­ï¼ˆpre_closeï¼‰
- âœ… é«˜æ€§èƒ½ï¼ˆ10,000+ QPSï¼‰
- âœ… ä½æµªè´¹ï¼ˆ< 0.1%ï¼‰
- âŒ å®ç°å¤æ‚åº¦è¾ƒé«˜ï¼ˆå¯æ¥å—ï¼‰

---

### 3. ä¸ºä»€ä¹ˆType 1ä½¿ç”¨Mapå»é‡è€Œä¸æ˜¯Bloom Filterï¼Ÿ

**æ–¹æ¡ˆå¯¹æ¯”**:

| æ–¹æ¡ˆ | å”¯ä¸€æ€§ | å†…å­˜ | æ€§èƒ½ |
|------|--------|------|------|
| Mapå»é‡ | 100% | é«˜ | æå¿« |
| Bloom Filter | 99.9% | ä½ | å¿« |

**é€‰æ‹©**: Mapå»é‡
- âœ… 100%å”¯ä¸€æ€§ä¿è¯
- âœ… å®ç°ç®€å•
- âŒ å†…å­˜å ç”¨é«˜ï¼ˆå¯¹äºå°è§„æ¨¡å¯æ¥å—ï¼‰
- ğŸ’¡ æ·»åŠ 80%é˜ˆå€¼é¿å…å†…å­˜çˆ†ç‚¸

**å»ºè®®**: å¦‚æœéœ€è¦è¶…å¤§è§„æ¨¡ï¼ˆ> 100ä¸‡ï¼‰ï¼Œå»ºè®®ç”¨Type 4 (Snowflake)

---

### 4. ä¸ºä»€ä¹ˆé€‰æ‹©å·¥å‚æ¨¡å¼ï¼Ÿ

**éœ€æ±‚**: 5ç§`auto_disk`ç­–ç•¥ï¼Œéœ€è¦åˆ›å»ºä¸åŒçš„Dispenserå®ç°

**æ–¹æ¡ˆå¯¹æ¯”**:
1. **ç›´æ¥åˆ›å»º**: ä»£ç è€¦åˆï¼Œéš¾ä»¥æ‰©å±•
2. **ç­–ç•¥æ¨¡å¼**: è¿è¡Œæ—¶åˆ‡æ¢ï¼Œä½†é…ç½®æ˜¯é™æ€çš„
3. **å·¥å‚æ¨¡å¼**: âœ… åˆ›å»ºæ—¶å†³å®šå®ç°ï¼Œæ¸…æ™°ä¸”é«˜æ•ˆ

**å®ç°**:
```go
type DispenserFactory struct {
    persistFunc func(string, Config, int64) error
}

func (f *DispenserFactory) CreateDispenser(name string, cfg Config) (NumberDispenser, error) {
    switch cfg.AutoDisk {
    case StrategyMemory:
        return NewDispenser(cfg)
    case StrategyPreClose:
        return NewOptimizedSegmentDispenser(cfg, ...)
    // ...
    }
}
```

**ä¼˜åŠ¿**:
- âœ… åˆ›å»ºé€»è¾‘é›†ä¸­
- âœ… æ˜“äºæ·»åŠ æ–°ç­–ç•¥
- âœ… é…ç½®é©±åŠ¨

---

## æ€§èƒ½ä¼˜åŒ–æŠ€å·§

### 1. é¿å…ä¸å¿…è¦çš„é”ç«äº‰

```go
// âŒ é”™è¯¯ï¼šç²—ç²’åº¦é”
func (d *Dispenser) Next() (string, error) {
    d.mu.Lock()
    defer d.mu.Unlock()
    
    // æ‰€æœ‰æ“ä½œéƒ½åœ¨é”å†…
    num := d.generateNumber()
    d.persist(num)  // â† ç£ç›˜IOä¹Ÿåœ¨é”å†…ï¼
    return num, nil
}

// âœ… æ­£ç¡®ï¼šç»†ç²’åº¦é”
func (d *Dispenser) Next() (string, error) {
    d.mu.Lock()
    num := d.current
    d.current++
    d.mu.Unlock()  // â† å°½æ—©é‡Šæ”¾é”
    
    // ç£ç›˜IOåœ¨é”å¤–
    d.persist(num)
    return num, nil
}
```

### 2. ä½¿ç”¨atomicæ“ä½œ

```go
// ç»Ÿè®¡ä¿¡æ¯ä½¿ç”¨atomicï¼Œé¿å…é”
type Dispenser struct {
    mu             sync.Mutex
    totalGenerated int64  // â† atomicæ“ä½œ
}

func (d *Dispenser) Next() (string, error) {
    // ...
    atomic.AddInt64(&d.totalGenerated, 1)  // æ— é”
    return num, nil
}
```

### 3. å¼‚æ­¥é¢„åŠ è½½

```go
// æ£€æŸ¥æ˜¯å¦éœ€è¦é¢„åŠ è½½ä¸‹ä¸€ä¸ªå·æ®µ
remaining := float64(sd.segmentEnd-sd.currentNumber) / float64(sd.segmentSize)
if remaining <= 0.2 && !sd.nextSegmentReady {
    go sd.preloadNextSegment()  // â† å¼‚æ­¥ï¼Œä¸é˜»å¡
}
```

---

## æœªæ¥æ”¹è¿›

### çŸ­æœŸï¼ˆv1.1ï¼‰

- [ ] æ”¯æŒæ›´å¤šRediså‘½ä»¤ï¼ˆMGET, EXISTS, KEYSï¼‰
- [ ] æ·»åŠ å‘½ä»¤è¡Œå‚æ•°ï¼ˆ--data-dir, --log-levelï¼‰
- [ ] æ”¯æŒé…ç½®æ–‡ä»¶

### ä¸­æœŸï¼ˆv1.2ï¼‰

- [ ] Webç®¡ç†ç•Œé¢
- [ ] PrometheusæŒ‡æ ‡å¯¼å‡º
- [ ] æ”¯æŒå·ç æ± é¢„çƒ­
- [ ] æ”¯æŒå·ç å›æ”¶

### é•¿æœŸï¼ˆv2.0ï¼‰

- [ ] åˆ†å¸ƒå¼åè°ƒï¼ˆåŸºäºetcd/consulï¼‰
- [ ] å¤šå‰¯æœ¬é«˜å¯ç”¨
- [ ] gRPCæ¥å£
- [ ] æ’ä»¶ç³»ç»Ÿ

---

## ç»éªŒæ€»ç»“

### 1. æ¸…æ™°çš„ç±»å‹ç³»ç»Ÿè‡³å…³é‡è¦

- ç±»å‹åç§°è¦ç›´æ¥åæ˜ åŠŸèƒ½
- é¿å…ä¸€ä¸ªç±»å‹åšå¤ªå¤šäº‹æƒ…
- é…ç½®é¡¹è¦ä¸€è‡´

### 2. æ€§èƒ½ä¸å¯é æ€§çš„å¹³è¡¡

- ç«‹å³ä¿å­˜ï¼šå¯é ä½†æ…¢
- å¼‚æ­¥ä¿å­˜ï¼šå¿«ä½†ä¸å¯é 
- å·æ®µ+æ£€æŸ¥ç‚¹+ä¼˜é›…å…³é—­ï¼šæœ€ä½³å¹³è¡¡

### 3. æµ‹è¯•é©±åŠ¨å¼€å‘

- æ¯ä¸ªæ–°ç±»å‹éƒ½å…ˆå†™æµ‹è¯•
- å¹¶å‘æµ‹è¯•å¿…ä¸å¯å°‘
- åŸºå‡†æµ‹è¯•éªŒè¯æ€§èƒ½

### 4. æ–‡æ¡£ä¸ä»£ç åŒæ­¥

- ä»£ç å˜æ›´åŒæ­¥æ›´æ–°æ–‡æ¡£
- æä¾›æ¸…æ™°çš„ç¤ºä¾‹
- è¯´æ˜è®¾è®¡å†³ç­–å’Œæƒè¡¡

---

## ç»“è¯­

Number Dispenser é¡¹ç›®é€šè¿‡é‡æ–°è®¾è®¡ç±»å‹ç³»ç»Ÿï¼Œå°†åŸæœ¬æ··æ·†çš„`repeat_mode`æ¦‚å¿µæ¸…æ™°åœ°åˆ’åˆ†ä¸º5ç§ç‹¬ç«‹çš„å‘å·å™¨ç±»å‹ï¼Œæ¯ç§ç±»å‹éƒ½æœ‰æ˜ç¡®çš„èŒè´£å’Œé€‚ç”¨åœºæ™¯ã€‚

åŒæ—¶ï¼Œé€šè¿‡å·æ®µé¢„åˆ†é…ã€æ£€æŸ¥ç‚¹å’Œä¼˜é›…å…³é—­ä¸‰é‡æœºåˆ¶ï¼Œåœ¨ä¿æŒé«˜æ€§èƒ½ï¼ˆQPS > 10,000ï¼‰çš„åŒæ—¶ï¼Œå°†å·ç æµªè´¹ç‡æ§åˆ¶åœ¨0.1%ä»¥ä¸‹ï¼Œè¾¾åˆ°äº†ç”Ÿäº§ç¯å¢ƒçš„è¦æ±‚ã€‚

é¡¹ç›®é‡‡ç”¨åˆ†å±‚æ¶æ„å’Œå·¥å‚æ¨¡å¼ï¼Œä½¿å¾—ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ˜“äºæ‰©å±•å’Œç»´æŠ¤ã€‚å®Œå–„çš„æµ‹è¯•è¦†ç›–ï¼ˆå•å…ƒæµ‹è¯• + å¹¶å‘æµ‹è¯• + åŸºå‡†æµ‹è¯•ï¼‰ç¡®ä¿äº†ä»£ç è´¨é‡ã€‚

è¿™ä¸ªé¡¹ç›®å±•ç¤ºäº†å¦‚ä½•åœ¨é«˜æ€§èƒ½ã€å¯é æ€§å’Œä»£ç æ¸…æ™°åº¦ä¹‹é—´æ‰¾åˆ°æœ€ä½³å¹³è¡¡ç‚¹ï¼Œæ˜¯ä¸€ä¸ªå€¼å¾—å­¦ä¹ å’Œå‚è€ƒçš„Goè¯­è¨€å®è·µæ¡ˆä¾‹ã€‚

---

**é¡¹ç›®çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª

**æœ€åæ›´æ–°**: 2025-10-29
